<% page_title "#{Spree.t(:shein_import)} ##{@shein_import.id}" %>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
          <i class="fa fa-download"></i>
          <%= Spree.t(:shein_import) %> #<%= @shein_import.id %>
        </h3>
        <span class="badge bg-<%= status_badge_color(@shein_import.status) %> fs-5">
          <%= @shein_import.status.humanize %>
        </span>
      </div>
      
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h5><%= Spree.t(:import_details) %></h5>
            <table class="table">
              <tr>
                <th><%= Spree.t(:search_term) %>:</th>
                <td><%= @shein_import.search_term %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:category_url) %>:</th>
                <td><%= link_to_if @shein_import.category_url.present?, truncate(@shein_import.category_url, length: 50), @shein_import.category_url, target: '_blank' %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:max_items) %>:</th>
                <td><%= @shein_import.max_items %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:auto_publish) %>:</th>
                <td><%= @shein_import.auto_publish? ? Spree.t(:yes) : Spree.t(:no) %></td>
              </tr>
            </table>
          </div>
          
          <div class="col-md-6">
            <h5><%= Spree.t(:progress) %></h5>
            <table class="table">
              <tr>
                <th><%= Spree.t(:started_at) %>:</th>
                <td><%= l(@shein_import.started_at, format: :short) if @shein_import.started_at %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:scraped_at) %>:</th>
                <td><%= l(@shein_import.scraped_at, format: :short) if @shein_import.scraped_at %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:completed_at) %>:</th>
                <td><%= l(@shein_import.completed_at, format: :short) if @shein_import.completed_at %></td>
              </tr>
              <tr>
                <th><%= Spree.t(:apify_run_id) %>:</th>
                <td><code><%= @shein_import.apify_run_id %></code></td>
              </tr>
            </table>
          </div>
        </div>
        
        <% if @shein_import.status == 'completed' %>
          <div class="alert alert-success">
            <h5><i class="fa fa-check-circle"></i> <%= Spree.t(:import_completed) %></h5>
            <p>
              <%= Spree.t(:products_imported) %>: <strong><%= @shein_import.products_imported_count %></strong><br>
              <%= Spree.t(:products_failed) %>: <strong><%= @shein_import.products_failed_count %></strong>
            </p>
          </div>
        <% elsif @shein_import.status == 'failed' %>
          <div class="alert alert-danger">
            <h5><i class="fa fa-exclamation-circle"></i> <%= Spree.t(:import_failed) %></h5>
            <p><%= @shein_import.errors&.dig('message') %></p>
          </div>
        <% elsif @shein_import.status == 'scraped' %>
          <div class="alert alert-info">
            <h5><i class="fa fa-info-circle"></i> <%= Spree.t(:scraping_completed) %></h5>
            <p><%= Spree.t(:products_scraped) %>: <strong><%= @shein_import.scraped_data&.count || 0 %></strong></p>
            <%= button_to Spree.t(:process_import), process_admin_shein_import_path(@shein_import), 
                method: :post, class: 'btn btn-primary' %>
          </div>
        <% elsif @shein_import.status == 'scraping' %>
          <div class="alert alert-warning">
            <h5><i class="fa fa-spinner fa-spin"></i> <%= Spree.t(:scraping_in_progress) %></h5>
            <p><%= Spree.t(:please_wait_scraping) %></p>
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
          </div>
        <% elsif @shein_import.status == 'processing' %>
          <div class="alert alert-warning">
            <h5><i class="fa fa-spinner fa-spin"></i> <%= Spree.t(:processing_in_progress) %></h5>
            <p><%= Spree.t(:please_wait_processing) %></p>
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
          </div>
        <% end %>
        
        <div class="mt-4">
          <%= link_to Spree.t(:back_to_imports), admin_shein_imports_path, class: 'btn btn-secondary' %>
          <% if @shein_import.status == 'scraped' %>
            <%= button_to Spree.t(:process_now), process_admin_shein_import_path(@shein_import), 
                method: :post, class: 'btn btn-primary' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @shein_import.status.in?(['scraping', 'processing']) %>
  <%= javascript_tag do %>
    // Auto-refresh every 5 seconds while scraping/processing
    setTimeout(function() {
      location.reload();
    }, 5000);
  <% end %>
<% end %>
