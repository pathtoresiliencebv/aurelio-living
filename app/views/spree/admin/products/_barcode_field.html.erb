<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title">
      <i class="fa fa-barcode"></i>
      <%= Spree.t(:barcode) %>
    </h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-8">
        <%= f.text_field :barcode, 
            class: 'form-control', 
            placeholder: Spree.t(:enter_barcode_or_generate),
            autocomplete: 'off' %>
        <small class="text-muted">
          <%= Spree.t(:barcode_help_text) %>
        </small>
      </div>
      <div class="col-md-4">
        <button 
          type="button" 
          class="btn btn-secondary w-100" 
          id="generate-barcode-btn"
          data-product-id="<%= product.persisted? ? product.id : '' %>"
        >
          <i class="fa fa-magic"></i>
          <%= Spree.t(:generate_barcode) %>
        </button>
      </div>
    </div>
    
    <% if product.barcode.present? %>
      <div class="mt-3">
        <div id="barcode-preview">
          <svg id="barcode-svg"></svg>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-barcode-btn');
    const barcodeInput = document.getElementById('product_barcode');
    const productId = generateBtn.dataset.productId;
    
    if (generateBtn && productId) {
      generateBtn.addEventListener('click', function() {
        if (!confirm('<%= Spree.t(:confirm_generate_barcode) %>')) {
          return;
        }
        
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> <%= Spree.t(:generating) %>...';
        
        fetch('/admin/barcode_scanner/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({ product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            barcodeInput.value = data.barcode;
            alert('<%= Spree.t(:barcode_generated_success) %>');
          } else {
            alert('<%= Spree.t(:barcode_generation_failed) %>: ' + data.error);
          }
        })
        .catch(error => {
          alert('<%= Spree.t(:barcode_generation_error) %>: ' + error.message);
        })
        .finally(() => {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="fa fa-magic"></i> <%= Spree.t(:generate_barcode) %>';
        });
      });
    }
  });
<% end %>
